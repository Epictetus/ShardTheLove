ShardTheLove shards.  Hard.


Using rSpec with ShardTheLove
=============================

Don't use fixtures with ShardTheLove.  You'll need a shard
in your databases.yml called "shard".

Add the following to your spec/spec_helper.rb in Merb or Rails:

----------------------

  # Set transactional_fixtures to false, we set up the replacement
  # for this functionality in the before and afters
  config.use_transactional_fixtures = false

  config.before(:all) do
    root = RAILS_ROOT || Merb.root
    Dir.foreach("#{root}/app/models/") do |file|
      next if file =~ /^\./ || !(file =~ /\.rb$/)
      require "#{root}/app/models/#{file}"
    end
    ShardTheLove.with('shard')
  end

  config.before(:each) do
    ActiveRecord::Base.send :increment_open_transactions
    ActiveRecord::Base.active_connections.each do |name,conn|
      conn.begin_db_transaction
    end
  end

  config.after(:each) do
    if Thread.current['open_transactions'] != 0
      ActiveRecord::Base.active_connections.each do |name,conn|
        conn.rollback_db_transaction
      end
      Thread.current['open_transactions'] = 0
    end
    ActiveRecord::Base.verify_active_connections!
  end

----------------------

& Enjoy.
